{% extends "auctions/layout.html" %}

{% block body %}
    <h2>Listing Detail</h2>

    {%if error_message%}
      {{error_message}}
    {%endif%}

    <script type="text/javascript">
      {% for message in messages %}
        msg = "{{message}}";
        e = document.getElementById("submit_result");
        e.innerHTML = "{{message}}";
      {% endfor %}
    </script>



    {% if user.is_authenticated %}

    <table border="1">
      <tr>
        <td><h4>{{listing.title}}</h4></td>
        <td>
          {% if user.is_authenticated and listing.by_user.id == user.id %}
            <a href="{% url 'auctions:u_manage_listing' listing.id %}">Manage This listing</a>
          {%endif%}
        </td>
      </tr>
      <tr>
        <td>
          {%if listing.photo_url %}<img src="{{listing.photo_url}}" height="200px" width="200px"> </p>
                 {%else%} No photo supplied {%endif%}

        </td>
        <td>
          <p>Listing Description: {{listing.description}} </p>
          <p>Starting Bid: {{listing.starting_bid}} </p>
          {% if listing.active is True %}
            <p>Current Bid: {{listing.current_bid}}</p>
          {% elif listing.active is False %}
            {% for bid in listing.bids_received.all %}
              {% if bid.winning_bid %}
                <div>Winner: {{bid.by_user.username}} </div>
                <div>This item was sold for ${{bid.bid_value}} </div>
              {%endif%}
            {% endfor %}
          {% endif %}
        </td>
      </tr>

      {% if listing.active %}
      <tr>
        <td><h6>Make a bid</h6></td>
        <td>
            <form action="{% url 'auctions:u_add_bid' %}" method="post">
                {% csrf_token %}
                <input type="number" name="bid" placeholder="Bid {{next_bid}} or higher" min="{{next_bid}}">
                <input type="hidden" name="listing" value="{{listing.id}}"></input>
                <input type="hidden" name="user" value="{{user.id}}"></input>
                {{create_form.as_p}}
                <input type="submit" value="Submit">
            </form>

            <div id="submit_result"></div>
        </td>
      </tr>
      <tr>
        <td><h6>Watch this item</h6></td>
        <td>
          <form action="{% url 'auctions:u_add_to_watchlist' listing.id %}" method="post">
              {% csrf_token %}
              <select name="watchlist">
                  {% for watchlist in user.watchlist.all %}
                      <option value="{{ watchlist.id }}">{{ watchlist.name }}</option>
                  {% endfor %}
              </select>

              <input type="hidden" name="user" value="{{user.id}}"></input>
              {{create_form.as_p}}
              <input type="submit" value="Add item to watchlist">
          </form>
        </td>
      </tr>
      {%endif%}

      <tr>
          <td colspan="2">
            <h6>Discuss this item  </h6>
          </td>
      </tr>
      {% for comment in listing.comments.all reversed%}
      <tr>
          <td colspan="2">
            by:{{comment.by_user.username}} : {{comment.content}}
          </td>
      </tr>
      {% endfor %}
      <tr>
        <td colspan="2">
          <form action="{% url 'auctions:u_add_comment' listing.id%}" method="post">
            {% csrf_token %}
            <textarea name="comment_body" rows="4" cols="80"></textarea>
            <p><input type="submit" value="Add comment"></p>
          </form>
          <!-- Show all previous comments made -->
        </td>
      </tr>
    </table>
    <ul>


      {% else %}
          <p>You must be signed in to Make a bid</p>
      {% endif %}

    </ul>
{% endblock %}
